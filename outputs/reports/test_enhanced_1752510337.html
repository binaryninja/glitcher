<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Domain Extraction Analysis Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-radius: 8px;
            --box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background: var(--light-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .report-meta {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .performance-banner {
            background: linear-gradient(45deg, #e7f3ff, #f0f8ff);
            border: 1px solid #b3d9ff;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .performance-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--info-color), var(--success-color));
        }

        .performance-banner h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            text-align: center;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .stat-card .icon {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .stat-card h3 {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-card p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .stat-card .percentage {
            font-size: 0.85rem;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
            margin-top: 5px;
        }

        .section {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            position: relative;
        }

        .section h2 {
            color: var(--dark-color);
            margin-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 10px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 1.2rem;
            opacity: 0.8;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
            gap: 5px;
        }

        .tab {
            padding: 12px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            transition: var(--transition);
            font-weight: 500;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--light-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .mini-chart {
            height: 250px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--light-color);
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
        }

        .control-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .control-group select,
        .control-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .pagination button:hover:not(:disabled) {
            background: var(--light-color);
            border-color: var(--primary-color);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .token-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
        }

        .token-card {
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 20px;
            background: #fafafa;
            transition: var(--transition);
            position: relative;
        }

        .token-card:hover {
            box-shadow: var(--box-shadow);
            transform: translateY(-1px);
        }

        .token-card.valid-domains { border-left: 4px solid var(--success-color); }
        .token-card.breaks-extraction { border-left: 4px solid var(--danger-color); }
        .token-card.both { border-left: 4px solid var(--warning-color); }
        .token-card.neither { border-left: 4px solid #6c757d; }
        .token-card.errors { border-left: 4px solid #e83e8c; }

        .token-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .token-id {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .token-display {
            background: #f1f3f4;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
            font-size: 0.85rem;
            border: 1px solid #dadce0;
            word-break: break-all;
            margin: 8px 0;
            max-height: 60px;
            overflow: hidden;
            position: relative;
        }

        .token-display.expandable::after {
            content: '...';
            position: absolute;
            bottom: 0;
            right: 8px;
            background: #f1f3f4;
            padding-left: 20px;
        }

        .issue-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 10px;
        }

        .issue-tag {
            display: inline-block;
            background: #e9ecef;
            color: #495057;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .stats-row .label {
            color: #666;
            font-weight: 500;
        }

        .stats-row .value {
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .loading::before {
            content: '';
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-info {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid var(--info-color);
        }

        .export-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .export-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .keyboard-shortcuts {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            display: none;
            z-index: 1000;
            max-width: 300px;
        }

        .keyboard-shortcuts.show {
            display: block;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .shortcut-item:last-child {
            border-bottom: none;
        }

        .key {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.8rem;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .metric-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #e9ecef;
            margin-top: 40px;
        }

        .text-muted { color: #666; }
        .text-success { color: var(--success-color); }
        .text-danger { color: var(--danger-color); }
        .text-warning { color: var(--warning-color); }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header { padding: 30px 20px; }
            .header h1 { font-size: 2rem; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .controls { flex-direction: column; }
            .control-group { min-width: auto; }
            .action-buttons { margin-left: 0; margin-top: 10px; }
            .report-meta { flex-direction: column; gap: 10px; }
            .chart-grid { grid-template-columns: 1fr; }
            .keyboard-shortcuts { position: relative; top: auto; right: auto; margin: 10px 0; }
        }

        @media print {
            .controls, .pagination, .action-buttons, .keyboard-shortcuts { display: none !important; }
            .section { break-inside: avoid; page-break-inside: avoid; }
            .header { background: var(--primary-color) !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Enhanced Domain Extraction Analysis</h1>
            <div class="subtitle">Advanced Interactive Report with Export & Analytics</div>
            <div class="report-meta">
                <span>📊 Model: meta-llama/Llama-3.2-1B-Instruct</span>
                <span>📅 Generated: 2025-07-14 12:25:37</span>
                <span>🔢 Report ID: cc5b9724</span>
                <span>⚡ Enhanced Mode</span>
            </div>
        </div>

        <div class="performance-banner">
            <h3>🚀 Performance Optimized</h3>
            <p>This enhanced report uses advanced pagination, lazy loading, and optimized rendering for datasets with 650 tokens.
            Features include real-time filtering, export functionality, keyboard shortcuts, and comprehensive analytics.</p>

            <div class="performance-metrics">
                <div class="metric-item">
                    <div class="metric-value">73.2%</div>
                    <div class="metric-label">Glitch Rate</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">2.5%</div>
                    <div class="metric-label">Success Rate</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">6</div>
                    <div class="metric-label">Issue Types</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">1.7</div>
                    <div class="metric-label">Avg Issues/Token</div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">📊</div>
                <h3>650</h3>
                <p>Total Tokens Analyzed</p>
                <div class="percentage" style="background: rgba(102, 126, 234, 0.1); color: var(--primary-color);">100%</div>
            </div>
            <div class="stat-card">
                <div class="icon">✅</div>
                <h3>16</h3>
                <p>Create Valid Domains</p>
                <div class="percentage text-success" style="background: rgba(40, 167, 69, 0.1);">2.5%</div>
            </div>
            <div class="stat-card">
                <div class="icon">⚠️</div>
                <h3>476</h3>
                <p>Break Extraction</p>
                <div class="percentage text-danger" style="background: rgba(220, 53, 69, 0.1);">73.2%</div>
            </div>
            <div class="stat-card">
                <div class="icon">🔄</div>
                <h3>50</h3>
                <p>Both Behaviors</p>
                <div class="percentage text-warning" style="background: rgba(255, 193, 7, 0.1);">7.7%</div>
            </div>
            <div class="stat-card">
                <div class="icon">❌</div>
                <h3>18</h3>
                <p>Processing Errors</p>
                <div class="percentage" style="background: rgba(232, 62, 140, 0.1); color: #e83e8c;">2.8%</div>
            </div>
        </div>

        <div class="section">
            <h2><span class="section-icon">📈</span>Interactive Analytics</h2>

            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">Overview</button>
                <button class="tab" onclick="showTab('distribution')">Distribution</button>
                <button class="tab" onclick="showTab('performance')">Performance</button>
                <button class="tab" onclick="showTab('issues')">Issue Analysis</button>
            </div>

            <div id="overview" class="tab-content active">
                <div class="chart-container">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>

            <div id="distribution" class="tab-content">
                <div class="chart-grid">
                    <div class="mini-chart">
                        <h4>Response Length Distribution</h4>
                        <canvas id="lengthChart"></canvas>
                    </div>
                    <div class="mini-chart">
                        <h4>Token Complexity Distribution</h4>
                        <canvas id="complexityChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="performance" class="tab-content">
                <div class="stats-row">
                    <span class="label">Average Response Length:</span>
                    <span class="value">63.1 characters</span>
                </div>
                <div class="stats-row">
                    <span class="label">Response Length Range:</span>
                    <span class="value">39 - 77 characters</span>
                </div>
                <div class="stats-row">
                    <span class="label">25th Percentile:</span>
                    <span class="value">58 characters</span>
                </div>
                <div class="stats-row">
                    <span class="label">Median (50th):</span>
                    <span class="value">66 characters</span>
                </div>
                <div class="stats-row">
                    <span class="label">75th Percentile:</span>
                    <span class="value">66 characters</span>
                </div>
                <div class="stats-row">
                    <span class="label">95th Percentile:</span>
                    <span class="value">73 characters</span>
                </div>
            </div>

            <div id="issues" class="tab-content">
                <div class="mini-chart">
                    <h4>Top Issues by Frequency</h4>
                    <canvas id="issuesChart"></canvas>
                </div>
            </div>
        </div>

        <div class="section">
            <h2><span class="section-icon">🔧</span>Data Export & Tools</h2>

            <div class="export-section">
                <h4>📤 Export Options</h4>
                <p>Export filtered data in various formats for further analysis:</p>
                <div class="export-options">
                    <button class="btn btn-primary" onclick="exportData('csv')">
                        📊 Export CSV
                    </button>
                    <button class="btn btn-secondary" onclick="exportData('json')">
                        📄 Export JSON
                    </button>
                    <button class="btn btn-success" onclick="exportData('summary')">
                        📋 Export Summary
                    </button>
                    <button class="btn btn-primary" onclick="toggleShortcuts()">
                        ⌨️ Keyboard Shortcuts
                    </button>
                </div>
            </div>
        </div>

        <div class="section">
            <h2><span class="section-icon">🔍</span>Token Analysis</h2>

            <div class="controls">
                <div class="control-group">
                    <label for="categoryFilter">Filter by Category:</label>
                    <select id="categoryFilter">
                        <option value="all">All Categories</option>
                        <option value="breaks_extraction">⚠️ Breaks Extraction</option>
                        <option value="both">🔄 Both Behaviors</option>
                        <option value="valid_domains">✅ Valid Domains Only</option>
                        <option value="neither">➖ Neither</option>
                        <option value="errors">❌ Errors</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="searchBox">Search Tokens:</label>
                    <input type="text" id="searchBox" placeholder="Search by token, ID, or issue...">
                </div>

                <div class="control-group">
                    <label for="sortBy">Sort by:</label>
                    <select id="sortBy">
                        <option value="id">Token ID</option>
                        <option value="response_length">Response Length</option>
                        <option value="issue_count">Issue Count</option>
                        <option value="complexity">Complexity</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="pageSize">Items per Page:</label>
                    <select id="pageSize">
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                    </select>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="resetFilters()">
                        🔄 Reset Filters
                    </button>
                    <button class="btn btn-primary" onclick="exportFiltered()">
                        📤 Export Filtered
                    </button>
                </div>
            </div>

            <div class="results-info" id="resultsInfo"></div>

            <div class="pagination" id="topPagination"></div>

            <div id="tokenContainer" class="token-grid">
                <div class="loading">Loading tokens...</div>
            </div>

            <div class="pagination" id="bottomPagination"></div>
        </div>

        <div class="keyboard-shortcuts" id="keyboardShortcuts">
            <h4>⌨️ Keyboard Shortcuts</h4>
            <div class="shortcut-item">
                <span>Next Page</span>
                <span><span class="key">→</span> or <span class="key">N</span></span>
            </div>
            <div class="shortcut-item">
                <span>Previous Page</span>
                <span><span class="key">←</span> or <span class="key">P</span></span>
            </div>
            <div class="shortcut-item">
                <span>Search</span>
                <span><span class="key">Ctrl</span> + <span class="key">F</span></span>
            </div>
            <div class="shortcut-item">
                <span>Export CSV</span>
                <span><span class="key">Ctrl</span> + <span class="key">E</span></span>
            </div>
            <div class="shortcut-item">
                <span>Reset Filters</span>
                <span><span class="key">Ctrl</span> + <span class="key">R</span></span>
            </div>
            <div class="shortcut-item">
                <span>Toggle Shortcuts</span>
                <span><span class="key">?</span></span>
            </div>
        </div>

        <div class="footer">
            <p>Enhanced Report generated on {timestamp} by Glitcher Domain Extraction Analyzer</p>
            <p>Report ID: {report_id} | Total Processing Time: Optimized | Memory Usage: Efficient</p>
        </div>
    </div>

    <script>
        // Global data store with enhanced functionality
        const reportData = {
            tokens: {json.dumps(analysis['tokens_by_category'])},
            itemsPerPage: {items_per_page},
            currentPage: 1,
            currentCategory: 'all',
            currentSearch: '',
            currentSort: 'id',
            filteredTokens: [],
            originalTokens: [],
            chartInstances: {},
            reportId: '{report_id}',
            timestamp: '{timestamp}',
            modelPath: '{data.get("model_path", "Unknown")}'
        };

        // Chart data
        const chartData = {json.dumps(chart_data)};

        // Initialize charts
        function initializeCharts() {{
            // Main distribution chart
            const ctx1 = document.getElementById('distributionChart').getContext('2d');
            reportData.chartInstances.distribution = new Chart(ctx1, {{
                type: 'doughnut',
                data: {{
                    labels: chartData.distribution.labels,
                    datasets: [{
                        data: chartData.distribution.data,
                        backgroundColor: chartData.distribution.colors,
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverBorderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed * 100) / total).toFixed(1);
                                    return context.label + ': ' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        duration: 1000
                    }
                }
            }});

            // Length distribution chart
            const ctx2 = document.getElementById('lengthChart').getContext('2d');
            reportData.chartInstances.length = new Chart(ctx2, {{
                type: 'bar',
                data: {{
                    labels: chartData.length_histogram.labels,
                    datasets: [{
                        label: 'Response Length Distribution',
                        data: chartData.length_histogram.data,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Number of Tokens' }
                        },
                        x: {
                            title: { display: true, text: 'Response Length (characters)' }
                        }
                    }
                }
            }});

            // Complexity chart
            const ctx3 = document.getElementById('complexityChart').getContext('2d');
            reportData.chartInstances.complexity = new Chart(ctx3, {{
                type: 'line',
                data: {{
                    labels: chartData.complexity.labels,
                    datasets: [{
                        label: 'Token Complexity Distribution',
                        data: chartData.complexity.data,
                        borderColor: 'rgba(40, 167, 69, 1)',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Number of Tokens' }
                        },
                        x: {
                            title: { display: true, text: 'Complexity Level' }
                        }
                    }
                }
            }});

            // Issues chart
            const ctx4 = document.getElementById('issuesChart').getContext('2d');
            reportData.chartInstances.issues = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: chartData.top_issues.labels,
                    datasets: [{
                        label: 'Issue Frequency',
                        data: chartData.top_issues.data,
                        backgroundColor: 'rgba(220, 53, 69, 0.7)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: { display: true, text: 'Frequency' }
                        }
                    }
                }
            });
        }}

        // Tab functionality
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Token management functions with enhanced features
        function getAllTokens() {
            if (reportData.currentCategory === 'all') {
                let allTokens = [];
                Object.keys(reportData.tokens).forEach(category => {
                    reportData.tokens[category].forEach(token => {
                        allTokens.push({...token, category});
                    });
                });
                return allTokens;
            } else {
                return reportData.tokens[reportData.currentCategory].map(token => {
                    return {...token, category: reportData.currentCategory};
                });
            }
        }

        function filterTokens() {
            let tokens = getAllTokens();
            reportData.originalTokens = [...tokens];

            // Apply search filter
            if (reportData.currentSearch) {
                const search = reportData.currentSearch.toLowerCase();
                tokens = tokens.filter(token => {
                    const tokenText = (token.full_token || token.token || '').toLowerCase();
                    const issues = (token.all_issues || []).join(' ').toLowerCase();
                    return tokenText.includes(search) ||
                           token.id.toString().includes(search) ||
                           issues.includes(search) ||
                           (token.top_issue && token.top_issue.toLowerCase().includes(search));
                });
            }

            // Apply sorting
            tokens.sort((a, b) => {
                switch (reportData.currentSort) {
                    case 'response_length':
                        return b.response_length - a.response_length;
                    case 'issue_count':
                        return b.issue_count - a.issue_count;
                    case 'complexity':
                        return (b.complexity || 0) - (a.complexity || 0);
                    default:
                        return a.id - b.id;
                }
            });

            reportData.filteredTokens = tokens;
            reportData.currentPage = 1;
            updateDisplay();
        }

        function formatTokenDisplay(token, maxLength = 25) {
            if (!token || token === 'Unknown') return '<span class="text-muted">Unknown</span>';

            let displayToken = token.length > maxLength ? token.substring(0, maxLength) + '...' : token;
            displayToken = displayToken.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

            return `<code class="token-display">${displayToken}</code>`;
        }

        function getCategoryClass(category) {
            const classes = {
                'valid_domains': 'valid-domains',
                'breaks_extraction': 'breaks-extraction',
                'both': 'both',
                'neither': 'neither',
                'errors': 'errors'
            };
            return classes[category] || '';
        }

        function renderTokens() {
            const container = document.getElementById('tokenContainer');
            const startIndex = (reportData.currentPage - 1) * reportData.itemsPerPage;
            const endIndex = startIndex + reportData.itemsPerPage;
            const pageTokens = reportData.filteredTokens.slice(startIndex, endIndex);

            if (pageTokens.length === 0) {
                container.innerHTML = '<div class="loading">No tokens found matching your criteria.</div>';
                return;
            }

            let html = '';
            pageTokens.forEach(token => {
                const categoryClass = getCategoryClass(token.category);

                html += `
                    <div class="token-card ${categoryClass}">
                        <div class="token-header">
                            <div class="token-id">${token.id}</div>
                            <div style="text-align: right; font-size: 0.8rem; color: #666;">
                                ${token.category.replace('_', ' ').toUpperCase()}
                            </div>
                        </div>

                        <div class="stats-row">
                            <span class="label">Token:</span>
                            <span class="value">${formatTokenDisplay(token.full_token || token.token)}</span>
                        </div>`;

                if (token.error) {
                    html += `
                        <div class="stats-row">
                            <span class="label">Error:</span>
                            <span class="value text-danger">${token.error}</span>
                        </div>`;
                } else {
                    html += `
                        <div class="stats-row">
                            <span class="label">Response Length:</span>
                            <span class="value">${token.response_length.toLocaleString()} chars</span>
                        </div>
                        <div class="stats-row">
                            <span class="label">Issues Found:</span>
                            <span class="value">${token.issue_count}</span>
                        </div>`;

                    if (token.complexity !== undefined) {
                        html += `
                            <div class="stats-row">
                                <span class="label">Complexity:</span>
                                <span class="value">${token.complexity}</span>
                            </div>`;
                    }

                    if (token.all_issues && token.all_issues.length > 0) {
                        html += '<div class="issue-tags">';
                        token.all_issues.slice(0, 5).forEach(issue => {
                            html += `<span class="issue-tag">${issue}</span>`;
                        });
                        if (token.all_issues.length > 5) {
                            html += `<span class="issue-tag">+${token.all_issues.length - 5} more</span>`;
                        }
                        html += '</div>';
                    }
                }

                html += '</div>';
            });

            container.innerHTML = html;
        }

        function renderPagination() {
            const totalPages = Math.ceil(reportData.filteredTokens.length / reportData.itemsPerPage);
            const currentPage = reportData.currentPage;

            let paginationHTML = '';

            // Previous button
            paginationHTML += `<button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>← Previous</button>`;

            // Page numbers (adaptive display)
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);

            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }

            if (startPage > 1) {
                paginationHTML += `<button onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span style="padding: 0 10px;">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                paginationHTML += `<button class="${activeClass}" onclick="changePage(${i})">${i}</button>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span style="padding: 0 10px;">...</span>`;
                }
                paginationHTML += `<button onclick="changePage(${totalPages})">${totalPages}</button>`;
            }

            // Next button
            paginationHTML += `<button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next →</button>`;

            // Page info
            const startItem = (currentPage - 1) * reportData.itemsPerPage + 1;
            const endItem = Math.min(currentPage * reportData.itemsPerPage, reportData.filteredTokens.length);
            paginationHTML += `<span style="margin-left: 20px; font-size: 0.9rem; color: #666;">
                Page ${currentPage} of ${totalPages} (${startItem}-${endItem} of ${reportData.filteredTokens.length.toLocaleString()})
            </span>`;

            document.getElementById('topPagination').innerHTML = paginationHTML;
            document.getElementById('bottomPagination').innerHTML = paginationHTML;
        }

        function updateResultsInfo() {
            const info = document.getElementById('resultsInfo');
            const total = reportData.filteredTokens.length;
            const originalTotal = reportData.originalTokens.length;
            const category = reportData.currentCategory === 'all' ? 'all categories' : reportData.currentCategory.replace('_', ' ');

            let infoText = `📊 Showing ${total.toLocaleString()} of ${originalTotal.toLocaleString()} tokens from ${category}`;
            if (reportData.currentSearch) {
                infoText += ` matching "${reportData.currentSearch}"`;
            }

            const filterRatio = originalTotal > 0 ? (total / originalTotal * 100).toFixed(1) : 0;
            infoText += ` (${filterRatio}% of category)`;

            info.innerHTML = infoText;
        }

        function updateDisplay() {
            renderTokens();
            renderPagination();
            updateResultsInfo();
        }

        function changePage(page) {
            const totalPages = Math.ceil(reportData.filteredTokens.length / reportData.itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                reportData.currentPage = page;
                updateDisplay();
                document.getElementById('tokenContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Export functionality
        function exportData(format) {
            const data = prepareExportData();

            switch (format) {
                case 'csv':
                    exportCSV(data);
                    break;
                case 'json':
                    exportJSON(data);
                    break;
                case 'summary':
                    exportSummary();
                    break;
            }
        }

        function prepareExportData() {
            return reportData.filteredTokens.map(token => ({
                token_id: token.id,
                token: token.full_token || token.token,
                category: token.category,
                response_length: token.response_length,
                issue_count: token.issue_count,
                issues: (token.all_issues || []).join('; '),
                complexity: token.complexity || 0,
                creates_valid: token.creates_valid || false,
                breaks_extraction: token.breaks_extraction || false
            }));
        }

        function exportCSV(data) {
            const headers = ['Token ID', 'Token', 'Category', 'Response Length', 'Issue Count', 'Issues', 'Complexity', 'Creates Valid', 'Breaks Extraction'];
            const csvContent = [
                headers.join(','),
                ...data.map(row => [
                    row.token_id,
                    `"${(row.token || '').replace(/"/g, '""')}"`,
                    row.category,
                    row.response_length,
                    row.issue_count,
                    `"${(row.issues || '').replace(/"/g, '""')}"`,
                    row.complexity,
                    row.creates_valid,
                    row.breaks_extraction
                ].join(','))
            ].join('\n');

            downloadFile(csvContent, `domain_analysis_${reportData.reportId}.csv`, 'text/csv');
        }

        function exportJSON(data) {
            const exportData = {
                metadata: {
                    report_id: reportData.reportId,
                    timestamp: reportData.timestamp,
                    model_path: reportData.modelPath,
                    total_tokens: data.length,
                    export_timestamp: new Date().toISOString()
                },
                tokens: data
            };

            downloadFile(JSON.stringify(exportData, null, 2), `domain_analysis_${reportData.reportId}.json`, 'application/json');
        }

        function exportSummary() {
            const summary = {
                report_id: reportData.reportId,
                model: reportData.modelPath,
                timestamp: reportData.timestamp,
                total_tokens: reportData.originalTokens.length,
                filtered_tokens: reportData.filteredTokens.length,
                categories: {
                    breaks_extraction: reportData.tokens.breaks_extraction.length,
                    both_behaviors: reportData.tokens.both.length,
                    valid_domains: reportData.tokens.valid_domains.length,
                    neither: reportData.tokens.neither.length,
                    errors: reportData.tokens.errors.length
                }
            };

            downloadFile(JSON.stringify(summary, null, 2), `domain_summary_${reportData.reportId}.json`, 'application/json');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exportFiltered() {
            exportData('csv');
        }

        function resetFilters() {
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('searchBox').value = '';
            document.getElementById('sortBy').value = 'id';
            reportData.currentCategory = 'all';
            reportData.currentSearch = '';
            reportData.currentSort = 'id';
            filterTokens();
        }

        function toggleShortcuts() {
            const shortcuts = document.getElementById('keyboardShortcuts');
            shortcuts.classList.toggle('show');
        }

        // Event listeners
        document.getElementById('categoryFilter').addEventListener('change', function(e) {
            reportData.currentCategory = e.target.value;
            filterTokens();
        });

        document.getElementById('searchBox').addEventListener('input', function(e) {
            reportData.currentSearch = e.target.value;
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                filterTokens();
            }, 300);
        });

        document.getElementById('sortBy').addEventListener('change', function(e) {
            reportData.currentSort = e.target.value;
            filterTokens();
        });

        document.getElementById('pageSize').addEventListener('change', function(e) {
            reportData.itemsPerPage = parseInt(e.target.value);
            reportData.currentPage = 1;
            updateDisplay();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchBox').focus();
            } else if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportData('csv');
            } else if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                resetFilters();
            } else if (e.key === '?' && !e.ctrlKey && !e.shiftKey) {
                toggleShortcuts();
            } else if (e.key === 'ArrowRight' || e.key === 'n') {
                if (!e.ctrlKey && document.activeElement.tagName !== 'INPUT') {
                    changePage(reportData.currentPage + 1);
                }
            } else if (e.key === 'ArrowLeft' || e.key === 'p') {
                if (!e.ctrlKey && document.activeElement.tagName !== 'INPUT') {
                    changePage(reportData.currentPage - 1);
                }
            }
        });

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            filterTokens();

            // Close shortcuts when clicking outside
            document.addEventListener('click', function(e) {
                const shortcuts = document.getElementById('keyboardShortcuts');
                if (!shortcuts.contains(e.target) && !e.target.closest('button[onclick="toggleShortcuts()"]')) {
                    shortcuts.classList.remove('show');
                }
            });

            // Show loading message
            console.log('Enhanced report initialized successfully');
        });
    </script>
</body>
</html>